<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.kosa.mini.board.BoardDAO"><!-- namespace 별칭 써 줄임말 만들기 -->
	<!-- UPPER(P.DELETEYN) = 'N' AND UPPER(M.DELETEYN) = 'N' AND BT.BOARDNAME = #{board}  -->
	<sql id="search">
		UPPER(P.DELETEYN) = 'N' AND UPPER(M.DELETEYN) = 'N' AND BT.BOARDNAME = #{board}
		<if test="searchValue != null and searchValue != ''">
			AND content LIKE concat(concat('%', #{searchValue}), '%')
		</if>
	</sql>
	<sql id="field1">
		P.POSTNO, BT.BOARDNAME, M.ID, P.TITLE, P.CONTENT, P.WRITER, P.VIEWS, P.CREATEDAT
	</sql>
	<sql id="join">
		TB_POST P
			JOIN 
			    TB_BOARDTYPE BT ON P.BOARDNO = BT.BOARDNO
			JOIN 
			    TB_MEMBER M ON P.MEMBERNO = M.MEMBERNO
	</sql>
	<select id="getBoard" resultType="org.kosa.mini.board.BoardVO">
		SELECT *
		FROM
			(SELECT ROWNUM RNUM, B.*
			FROM
				(SELECT 
					<include refid="field1"/>
				FROM 
					<include refid="join"/>
				WHERE 
				     <include refid="search"/>) B
			WHERE ROWNUM BETWEEN 1 AND #{end}) POST
		WHERE RNUM BETWEEN #{start} AND #{end}
		ORDER BY POSTNO DESC
	</select>
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*)
		FROM 
			<include refid="join"/>
		WHERE 
		     <include refid="search"/>
	</select>
	<select id="getPost" resultType="org.kosa.mini.board.BoardVO">
		SELECT 
			<include refid="field1"/>
		FROM
			<include refid="join"/>
		WHERE
			<include refid="search"/> AND POSTNO = #{postNo}
	</select>
	<update id="addViewCnt">
		UPDATE
			TB_POST
		SET
			VIEWS = VIEWS + 1
		WHERE
			POSTNO = #{postNo}
	</update>
</mapper>

